<!-- This file has been generated by the concat.sh script. -->
<!-- Don't modify this file manually (you'll loose your changes) -->
<!-- but run the tool once more -->
<!-- Last refresh date: Wednesday, February 08, 2023, 07:44:03 -->

# Write PHP Unit tests using PestPHP

![Banner](./banner.svg)

> [https://pestphp.com/](https://pestphp.com/)

PestPHP is a wrapper around PhpUnit so, for instance, every command line arguments supported by PhpUnit can be used for PestPHP.

<!-- table-of-contents - start -->
* [Introduction](#introduction)
* [Installation](#installation)
* [Writing tests](#writing-tests)
  * [Introduction about PestPhp](#introduction-about-pestphp)
    * [Files should have the Test suffix](#files-should-have-the-test-suffix)
    * [What means $this in a test?](#what-means-this-in-a-test)
    * [it or test](#it-or-test)
  * [Our first tests](#our-first-tests)
    * [Autocomplete](#autocomplete)
    * [Difference between toBe and toEqual](#difference-between-tobe-and-toequal)
  * [Assertions](#assertions)
  * [Expectations](#expectations)
  * [Using datasets](#using-datasets)
* [Write global functions](#write-global-functions)
* [PestPHP bootstrap](#pestphp-bootstrap)
* [Tips and tricks](#tips-and-tricks)
  * [Dump and die](#dump-and-die)
* [Tools](#tools)
  * [Laravel plugin](#laravel-plugin)
  * [Visual Studio Code Addon](#visual-studio-code-addon)
    * [Better Pest with Docker](#better-pest-with-docker)
  * [Convert from PHPUnit to PestPHP](#convert-from-phpunit-to-pestphp)
* [Links](#links)
  * [Videos](#videos)<!-- table-of-contents - end -->

## Introduction

## Installation

> [https://pestphp.com/docs/installation#installation](https://pestphp.com/docs/installation#installation)

```bash
composer require pestphp/pest --dev --with-all-dependencies

composer require pestphp/pest-plugin-laravel --dev
php artisan pest:install

./vendor/bin/pest --init
```

From now, we can run `./vendor/bin/pest` to run our PestPHP tests.

## Writing tests

### Introduction about PestPhp

#### Files should have the Test suffix

Just like PHPUnit, PestPHP will process every files in folders `tests/Feature` and `tests/Unit` having the `Test` suffix like f.i. `ShoppingBasketTest.php`.

#### What means $this in a test?

In our `tests/Pest.php` file, we've this line:

```php
uses(Tests\TestCase::class)->in('Features');
```

In a Pest test, `$this` refers to the PHPUnit `Tests\TestCase` class.

#### it or test

PestPHP give us the choice between `it()` and `test()`. *Use the one that best fits your test naming convention, or both. They share the same behavior & syntax.*

Read more: [https://pestphp.com/docs/writing-tests#api-reference](https://pestphp.com/docs/writing-tests#api-reference)

The result is the same, just how the output is done on the console.

### Our first tests

Create a file like `tests/Feature/MyFirstTest.php` with this content:

```php
<?php

test('assert true is true', function () {
    expect(true)->toBeTrue();
});

test('assert false is not true', function () {
    expect(false)->not->toBeTrue();   // we can also write `not()->`
});
```

This illustrate that PestPhp start with a `expect` verb and some method like `toBeTrue()`.  Methods can be negated using `not->` ([https://pestphp.com/docs/expectations#expect-not](https://pestphp.com/docs/expectations#expect-not)).

Running our test can be simply done using `./vendor/bin/pest tests/Feature/MyFirstTest.php` and here is the result:

```text
   PASS  Tests\Feature\MyFirstTest
  ✓ assert true is true
  ✓ assert false is not true

  Tests:  2 passed
  Time:   0.08s
```

#### Autocomplete

![Auto complete](./030_writing_tests/020_first_tests/010_autocomplete/images/autocomplete.png)

Make sure to install and enable [PHP Intelephense](https://marketplace.visualstudio.com/items?itemName=bmewburn.vscode-intelephense-client) and enjoy the auto-complete feature of vscode.

#### Difference between toBe and toEqual

```php
<?php

test('assert count is correct', function () {
    expect(2 + 2)->toBe(4);       // Will be true
    expect(2 + 2)->toBe('4');     // Will NOT be true

    expect(2 + 2)->toEqual(4);    // Will be true
    expect(2 + 2)->toEqual('4');  // Will be true 
});
```

`toBe` will be more strict i.e. will check both the value and the data type when, `toBe` will just check the value.

### Assertions

> [https://pestphp.com/docs/assertions](https://pestphp.com/docs/assertions)

Assertions comes from PhpUnit and works the same way.

Assertions are accessible through the `$this` object and this because  `tests/pest.php` contains the line below.

```php
uses(Tests\TestCase::class)->in('Feature');
```

So `$this` refers to the `Tests\TestCase` PHPUnit class.

### Expectations

> [https://pestphp.com/docs/expectations](https://pestphp.com/docs/expectations)

*In addition to assertions, Pest offers you a set of expectations. These functions let you test your values against certain conditions. This API is inspired by Jest. Expectations also allow you to write your tests like you would a natural sentence*

Assertions and expectations can be used in PestPHP tests files but ... expectations are more explicits and intuitive.


```php
<?php

test('assert true is true', function () {
    // These two lines do exactly the same. Keep just one...
    $this->assertTrue(true);
    expect(true)->toBeTrue();
});

### Using datasets

> [https://pestphp.com/docs/datasets](https://pestphp.com/docs/datasets)

We've multiple way to provide data to a function.

Here is [inline](https://pestphp.com/docs/datasets#inline-datasets)

```php
it('has emails', function (string $email) {
    expect($email)->not->toBeEmpty();
})->with([
    'enunomaduro@gmail.com',
    'other@example.com'
]);
```

The dataset is then an array and we can have a multi-dimension array:

```php
it('has emails', function (string $name, string $email) {
    expect($email)->not->toBeEmpty();
})->with([
    ['Nuno', 'enunomaduro@gmail.com'],
    ['Other', 'other@example.com']
]);
```

There is also a way to create a shared dataset which is probably better when the test file becomes big ([https://pestphp.com/docs/datasets#shared-datasets](https://pestphp.com/docs/datasets#shared-datasets)).

## Write global functions

We can write our own custom functions in the `tests/Pest.php` file.

## PestPHP bootstrap

The file `tests/pest.php` can be used to place there global function but we'll also need to update it if, inside our tests files, we need some other classes.

```php
uses(Tests\TestCase::class)->in('Feature');
```

The line above will make `Tests\TestCase` available in all tests in `tests/Feature`. If we need more classes, we can add them:

```php
uses(Tests\TestCase::class,Illuminate\Foundation\Testing\RefreshDatabase::class)->in('Feature');
```

And also in the `test/Unit` folder:

```php
uses(Tests\TestCase::class)->in('Unit');
```

## Tips and tricks

### Dump and die

We can use the `dd` method to dump the current expectation value and end the test suite like this:

```php
expect($response)
    ->dd()
    ->toHaveKey('data')
    ->data->toBeEmpty();
```

## Tools

### Laravel plugin

> [Laravel Pest plugin](https://pestphp.com/docs/plugins/laravel)

Install the plugin like this: `composer require pestphp/pest-plugin-laravel --dev`

Then some new artisan commands will be available:

```bash
php artisan | grep pest
 pest
  pest:dataset           Create a new dataset file
  pest:install           Creates Pest resources in your current PHPUnit test suite
  pest:test              Create a new test file
```

### Visual Studio Code Addon

* If not yet installad, [PHP Intelephense](https://marketplace.visualstudio.com/items?itemName=bmewburn.vscode-intelephense-client) will allow you to press <kbd>F12</kbd> on a method name (like `toBeTrue`) and jump where the method is implemented,
* [Better Pest](https://marketplace.visualstudio.com/items?itemName=m1guelpf.better-pest) and
* [Pest Snippets](https://marketplace.visualstudio.com/items?itemName=dansysanalyst.pest-snippets)

#### Better Pest with Docker

If you're using Docker, think to add the next lines in your `.vscode/settings.json` configuration file:

```json
{
    "better-pest.docker.enable": true,
    "better-pest.docker.command": "docker compose exec -u root:root app",
    "better-pest.docker.paths": {
        "/your/local/path": "/your/remote/path"
    }
}
```

Think to adjust the name of your container (`app` here) and paths:

* `/your/local/path` is where your repository is stored, on your host machine,
* `/your/remote/path` is the path in your container, probably `/var/www/html`.

Now, just open any PestPhp file and press <kbd>CTRL</kbd>+<kbd>Shift</kbd>+<kbd>P</kbd> to open the Command Palette. Start to type `Better Pest` and select the desired option (like `Better Pest: run` for running the file).

### Convert from PHPUnit to PestPHP

The repository [https://github.com/mandisma/pest-converter](https://github.com/mandisma/pest-converter) propose a **PHPUnit to Pest Converter**: PestConverter is a PHP library for converting PHPUnit tests to Pest tests.

## Links

### Videos

* [Laracast - PestPHP](https://laracasts.com/series/jeffreys-larabits/episodes/30)
* [Laracast - Pest from Scratch](https://laracasts.com/series/pest-from-scratch)
